---
- hosts: localhost
  connection: local
  become: true

  tasks:
    # ---------------------------------------------------------
    # 1. PRE-CHECKS: See what is already installed
    # ---------------------------------------------------------
    - name: Check if Docker is already installed
      command: which docker
      register: docker_check
      ignore_errors: yes
      changed_when: false

    - name: Check if Minikube is already installed
      command: which minikube
      register: minikube_check
      ignore_errors: yes
      changed_when: false

    - name: Check if Kubectl is already installed
      command: which kubectl
      register: kubectl_check
      ignore_errors: yes
      changed_when: false

    # ---------------------------------------------------------
    # 2. INSTALLATION: Only run if tools are missing
    # ---------------------------------------------------------
    - name: Install required prerequisites (only if Docker missing)
      apt:
        name:
          - apt-transport-https
          - ca-certificates
          - curl
          - gnupg-agent
          - software-properties-common
          - conntrack
        state: present
        update_cache: yes
      when: docker_check.rc != 0

    - name: Install Docker (only if missing)
      apt:
        name: docker.io
        state: present
      when: docker_check.rc != 0

    - name: Ensure Docker service is running
      service:
        name: docker
        state: started
        enabled: yes
      when: docker_check.rc != 0

    - name: Add Jenkins user to docker group (CI requirement)
      user:
        name: jenkins
        groups: docker
        append: yes

    - name: Download Minikube (only if missing)
      get_url:
        url: https://storage.googleapis.com/minikube/releases/latest/minikube-linux-amd64
        dest: /usr/local/bin/minikube
        mode: '0755'
      when: minikube_check.rc != 0

    - name: Download Kubectl (only if missing)
      get_url:
        url: "https://dl.k8s.io/release/v1.28.0/bin/linux/amd64/kubectl"
        dest: /usr/local/bin/kubectl
        mode: '0755'
      when: kubectl_check.rc != 0

    # ---------------------------------------------------------
    # 3. CONFIGURATION: Start Minikube as Jenkins (robust check)
    # ---------------------------------------------------------
    - name: Check if Minikube container exists (Jenkins)
      become: false
      become_user: jenkins
      shell: >
        docker ps -a --format '{{ "{{.Names}}" }}' | grep -w minikube
      register: minikube_container
      failed_when: false
      changed_when: false

    - name: Start Minikube as Jenkins (log to file)
      become: false
      become_user: jenkins
      shell: |
        LOG_FILE="$HOME/minikube-start.log"
        echo "==== Minikube start at $(date) ====" >> "$LOG_FILE"
        minikube start \
          --driver=docker \
          --memory=3000 \
          --cpus=2 >> "$LOG_FILE" 2>&1
      args:
        executable: /bin/bash
      when: minikube_container.rc != 0

    - name: Wait for Minikube API server to be ready
      become: false
      become_user: jenkins
      shell: |
        until minikube status | grep -q "apiserver: Running"; do
          echo "Waiting for Kubernetes API..."
          sleep 10
        done
      changed_when: false
      when: minikube_container.rc != 0

    # ---------------------------------------------------------
    # 4. PRE-PULL RUNTIME IMAGES INSIDE MINIKUBE (Jenkins-owned)
    # ---------------------------------------------------------
    - name: Pre-pull runtime images inside Minikube
      become: false
      become_user: jenkins
      shell: |
        eval $(minikube docker-env)
        docker pull node:18-alpine
        docker pull python:3.9-alpine
        docker pull golang:1.19-alpine
        docker pull gcc:latest
      args:
        executable: /bin/bash
      when: minikube_container.rc != 0
